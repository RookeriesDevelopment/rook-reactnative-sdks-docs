# Rook Health Connect SDK

This SDK enables apps to extract data from Google Health Connect. `rook_health_connect` is part of Rook Extraction, a series of SDKs dedicated to extracting Health Data from a variety of [Data Sources](https://docs.tryrook.io/docs/Definitions#data-sources).

This SDK was developed with the Health Connect [native SDK](https://developer.android.com/guide/health-and-fitness/health-connect), so all its limitations and requirements apply to this SDK as well.

## Features

- Check for Health Connect app availability.
- Check and request permissions.
- Retrieve a [Sleep Summary](https://docs.tryrook.io/docs/DataStructure/SleepHealth#summaries) from a specific day.
- Retrieve a [Physical Summary](https://docs.tryrook.io/docs/DataStructure/PhysicalHealth#summaries) from a specific day.
- Retrieve a [Body Summary](https://docs.tryrook.io/docs/DataStructure/BodyHealth#summaries) from a specific day.

## Installation

![Maven Central](https://img.shields.io/maven-central/v/com.rookmotion.android/rook-health-connect?color=%23F44336)

Add the following line to your dependencies (app-level build.gradle):

```groovy
implementation 'com.rookmotion.android:rook-health-connect:version'
```

## Getting started

To get authorization to use this SDK, you'll need to install and configure the [rook-auth](https://mvnrepository.com/artifact/com.rookmotion.android/rook-auth) SDK.

### Android Configuration

In your **AndroidManifest.xml**, add a query for Health Connect:

```xml

<manifest>
    <queries>
        <package android:name="com.google.android.apps.healthdata" />
    </queries>
</manifest>

```

Then declare the health permissions used by this SDK:

```text
<uses-permission android:name="android.permission.health.READ_SLEEP" />
<uses-permission android:name="android.permission.health.READ_STEPS" />
<uses-permission android:name="android.permission.health.READ_DISTANCE" />
<uses-permission android:name="android.permission.health.READ_FLOORS_CLIMBED" />
<uses-permission android:name="android.permission.health.READ_ELEVATION_GAINED" />
<uses-permission android:name="android.permission.health.READ_OXYGEN_SATURATION" />
<uses-permission android:name="android.permission.health.READ_VO2_MAX" />
<uses-permission android:name="android.permission.health.READ_TOTAL_CALORIES_BURNED" />
<uses-permission android:name="android.permission.health.READ_ACTIVE_CALORIES_BURNED" />
<uses-permission android:name="android.permission.health.READ_HEART_RATE" />
<uses-permission android:name="android.permission.health.READ_RESTING_HEART_RATE" />
<uses-permission android:name="android.permission.health.READ_HEART_RATE_VARIABILITY" />
<uses-permission android:name="android.permission.health.READ_EXERCISE" />
<uses-permission android:name="android.permission.health.READ_SPEED" />
<uses-permission android:name="android.permission.health.READ_WEIGHT" />
<uses-permission android:name="android.permission.health.READ_HEIGHT" />
<uses-permission android:name="android.permission.health.READ_BLOOD_GLUCOSE" />
<uses-permission android:name="android.permission.health.READ_BLOOD_PRESSURE" />
<uses-permission android:name="android.permission.health.READ_HYDRATION" />
<uses-permission android:name="android.permission.health.READ_BODY_TEMPERATURE" />

```

Finally, inside the Activity that you use to display your app's privacy policy, add an intent filter for the Health Connect permissions action:

```xml

<activity android:name=".ui.health_connect.HCPrivacyPolicyActivity" android:enabled="true"
    android:exported="true">

    <intent-filter>
        <action android:name="androidx.health.ACTION_SHOW_PERMISSIONS_RATIONALE" />
    </intent-filter>
</activity>

```

In your build.gradle (app), set your min and target sdk version like below:

```groovy
minSdk 26
targetSdk 33

```

This package will only work with devices of SDK 28 or later. The `minSdk 26` is to keep compatibility with other Rook SDKs that can be used with older SDKs.

### Logging

If you want to see the logs generated by this SDK, when creating an instance of `RookHealthConnectManager`, provide a logLevel:

```
RookHealthConnectManager(logLevel = "ADVANCED")

```

Available levels:

- "ADVANCED" -> All logs from API. All logs from SDK.
- "BASIC" -> Basic logs from API. All logs from SDK.
- "NONE" -> No logs.

## Usage

Create an instance of `RookHealthConnectManager` providing a context:

```kotlin
val manager = RookHealthConnectManager(context)

```

### Privacy policy

Health Connect requires a privacy policy where you inform your users how you will handle and use their data.

In the [Android configuration](#android-configuration) section, an intent filter was added to listen when your app is launched from said intent. You can use a dedicated Activity, or if you are using a **Single activity architecture**, you can use Deeplink. You can find an example of the first approach in our demo app.

### Check compatibility

Before using any of the features of `rook_health_connect`, you need to ensure the user's device is compatible with Health Connect and check if the [APP](https://play.google.com/store/apps/details?id=com.google.android.apps.healthdata) is installed.

Call `checkAvailability` to check for the app. This will return an `AvailabilityStatus`.

| Status | Description | What to do |
| --- | --- | --- |
| INSTALLED | App is installed | Proceed to check permissions |
| NOT_INSTALLED | App is not installed | Prompt the user to install Health Connect. |
| NOT_SUPPORTED | This device does not support Health Connect | Take the user out of the Health Connect section |

### Permissions

#### Check

There are dedicated functions for each [Health Pillar](https://docs.tryrook.io/docs/Definitions#health-data-pillars) (Sleep, Physical, and Body) to check permissions. These functions follow the convention: `has_data_type_Permissions`.

You can also call `hasAllPermissions` to check if your app has all the permissions required to extract data from all health pillars.

```kotlin
fun checkPermissions() {
    scope.launch {
        val result = manager.hasAllPermissions()

        if (result) {
            // The app has permissions.
        } else {
            // The app does not have permissions.
        }
    }
}

```

#### Request

There are dedicated functions for each health pillar (Sleep, Physical, and Body) to request permissions. These functions follow the convention: `request_data_type_Permissions`.

You can also call `requestAllPermissions` and provide an `Activity` instance to request all health pillar permissions.

```kotlin
fun requestPermissions(activity: Activity) {
    val result = manager.requestAllPermissions(activity)

    if (result) {
        // A request to Health Connect to open the permissions screen was sent.
        // Health Connect can receive the request but refuse to open the permissions screen. In those cases, 'result' will also be true
    } else {
        // The request was not sent.
    }
}

```

**Permissions denied**

If the user clicks cancel or navigates away from the permissions screen, Health Connect will take it as if the user denied the permissions.

If the user 'denies' the permissions 2 times, your app will be blocked by Health Connect. This is permanent and cannot be undone even if the user uninstalls your app.

When your app is blocked, any permissions request will be ignored.

To solve this problem, we recommend you also include an `Open Health Connect` button in your permissions UI. This button will call `openHealthConnectSettings`, and your users can manually grant permissions to your app.

```kotlin
fun openHealthConnectSettings() {
    val result = manager.openHealthConnectSettings()

    if (result) {
        // A request to open Health Connect was sent.
    } else {
        // The request was not sent.
    }
}

```

### Retrieving data

To retrieve any type of summary, you need to provide a date. This date cannot be the current day and cannot be older than 29 days. See the examples below:

| Current date | Provided date | Is valid? |
| --- | --- | --- |
| @January 8, 2023 | @January 8, 2023 | No, the date is today |
| @January 8, 2023 | @January 7, 2023 | Yes, the date is from yesterday |
| @January 8, 2023 | @November 1, 2022 | No, the date is older than 29 days |
| @January 8, 2023 | @January 1, 2023 | Yes, the date is 7 days old |

To get health data, call `get_data_type` and provide a `ZonedDateTime` instance of the day you want to retrieve the data from.

For example, if you want to get yesterday's sleep summary, call `getSleepSummary`. It will return a `SleepSummary` instance or throw an exception if an error happens or if there is no sleep data on that day.

```kotlin
fun getSleepSummary() {
    scope.launch {
        try {
            val date = ZonedDateTime.now().minusDays(1)
            val result = manager.getSleepSummary(date)

            // Success
        } catch (e: Exception) {
            // Manage error
        }
    }
}

```

### Keeping track of the last time a summary was retrieved

Health Connect does not allow retrieving data in the background, so every time your users open your app, you should retrieve the data manually to help you retrieve the data of the days the user did not open your app. We store in preferences the last date data was retrieved from (even if that attempt resulted in no data being found).

Depending on the data type, there are multiple functions to retrieve that date. They follow the convention: `get_data_type_LastDate`.

It will return a `ZonedDateTime` instance.

#### Example

Let's suppose that one of your users opens the app on `2023-01-10`. The app then retrieves a sleep summary from yesterday (`2023-01-09`) with `getSleepSummary`, gets the summary, and sends it to the backend.

Then the user forgets to open the app until `2023-01-15`. Then you'll call `getSleepSummaryLastDate`. It will return `2023-01-09` in a `ZonedDateTime` instance. Now, in a loop, you can recover data from the days the user did not open the app (`2023-01-10` to `2023-01-14`).

An example using sleep summaries is detailed below:

```kotlin
fun recoverLostDays() {
    scope.launch {
        val today = LocalDate.now()
        var date = manager.getSleepSummaryLastDate().toLocalDate()

        date = date.plusDays(1)

        while (date.isBefore(today)) {
            try {
                val result = manager.getSleepSummary(date.atStartOfDay(ZoneId.systemDefault()))

                // Success
            } catch (e: Exception) {
                // Manage error
            }

            date = date.plusDays(1)
        }
    }
}

```